# AzurBepInExPlugin

A plugin that can let you execute some gm functions



# Install

Since `HybridCLR` modifies `Il2Cpp` a lot, you need to modify both `Il2CppInterop` and `GameAssembly.dll` before using the plugin.

- Il2CppInterop:

  In`Il2CppInterop.Runtime/Injection/Hooks/MetadataCache_GetTypeInfoFromTypeDefinitionIndex_Hook.cs`, change

  ```C#
  [UnmanagedFunctionPointer(CallingConvention.Cdecl)]
  internal delegate Il2CppClass* MethodDelegate(int index);
  
  private Il2CppClass* Hook(int index)
  {
      if (InjectorHelpers.s_InjectedClasses.TryGetValue(index, out IntPtr classPtr))
          return (Il2CppClass*)classPtr;
  
      return Original(index);
  }
  ```

  to

  ```C#
  [UnmanagedFunctionPointer(CallingConvention.Cdecl)]
  internal delegate Il2CppClass* MethodDelegate(long index);
  
  private Il2CppClass* Hook(long index)
  {
      if (InjectorHelpers.s_InjectedClasses.TryGetValue(index, out IntPtr classPtr))
          return (Il2CppClass*)classPtr;
  
      return Original(index);
  }
  ```

  In`Il2CppInterop.Runtime/Injection/Hooks/Class_GetFieldDefaultVaule_Hook.cs`, change

  ```C#
  public override IntPtr FindTargetMethod()
  {
      // NOTE: In some cases this pointer will be MetadataCache::GetFieldDefaultValueForField due to Field::GetDefaultFieldValue being
      // inlined but we'll treat it the same even though it doesn't receive the type parameter the RDX register
      // doesn't get cleared so we still get the same parameters
      var classGetDefaultFieldValue = s_Signatures
          .Select(s => MemoryUtils.FindSignatureInModule(InjectorHelpers.Il2CppModule, s))
          .FirstOrDefault(p => p != 0);
  
      if (classGetDefaultFieldValue == 0)
      {
          Logger.Instance.LogTrace("Couldn't fetch Class::GetDefaultFieldValue with signatures, using method traversal");
          classGetDefaultFieldValue = FindClassGetFieldDefaultValueXref();
      }
  
      return classGetDefaultFieldValue;
  }
  ```

  to

  ```C#
  public override IntPtr FindTargetMethod()
  {
      return FindClassGetFieldDefaultValueXref();
  }
  ```

  Or just download the modified version in release page.

  

- GameAssembly.dll

  Patch with following using x64dbg:

  ```
  >gameassembly.dll
  00000000006E9C8E:0F->90
  00000000006E9C8F:85->90
  00000000006E9C90:DF->90
  00000000006E9C91:02->90
  00000000006E9C92:00->90
  00000000006E9C93:00->90
  0000000000933179:0F->90
  000000000093317A:85->90
  000000000093317B:E7->90
  000000000093317C:00->90
  000000000093317D:00->90
  000000000093317E:00->90
  ```

After that, copy the plugin to `BepInex/plugins` and enjoy.



# Develop

Copy bepinex dlls to `libs/bepinex` and copy dummydlls generated by bepinex to `libs/game`.